<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест графиков - Shopping Tracker</title>
	<link href="css/styles.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/api.js"></script>
    <script src="js/charts.js"></script>
		
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        .test-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        button {
            padding: 10px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-wrapper {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chart-wrapper h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        canvas {
            width: 100% !important;
            height: 300px !important;
        }
        
        .status {
            padding: 10px;
            background: #e8f4fc;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Тестирование графиков Shopping Tracker</h1>
        
        <div class="status" id="status">
            Статус: Ожидание действий...
        </div>
        
        <div class="test-controls">
            <button onclick="testCategoryChart()">Категории (Bar)</button>
            <button onclick="testCategoryPie()">Категории (Pie)</button>
            <button onclick="testMonthlyChart()">Месячные расходы</button>
            <button onclick="testStoreChart()">Сравнение магазинов</button>
            <button onclick="testTrendChart()">Тренд расходов</button>
            <button onclick="testToggleLabels()">Вкл/Выкл подписи</button>
            <button onclick="testExportAll()">Экспорт всех</button>
            <button onclick="clearCharts()">Очистить все</button>
        </div>
        
        <div class="charts-container" id="chartsContainer">
            <!-- Canvas элементы будут созданы динамически -->
        </div>
		
		<div class="test-section">
			<h3>Этап 3: Интерактивность и сравнение</h3>
			
			<div class="test-controls">
				<button onclick="testInteractiveChart()">Интерактивный график</button>
				<button onclick="testPeriodComparison()">Сравнение периодов</button>
				<button onclick="testSaveConfig()">Сохранить конфигурацию</button>
				<button onclick="testRestoreConfigs()">Восстановить все</button>
				<button onclick="testComparisonDashboard()">Дашборд сравнения</button>
			</div>
			
			<div id="comparisonDashboard"></div>
		</div>
		
    </div>
    
    <!-- Подключение библиотек
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/api.js"></script>
    <script src="js/charts.js"></script> -->
    
    <script>
        // Обновляем статус
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = `Статус: ${message}`;
            statusEl.style.background = type === 'error' ? '#fdecea' : 
                                       type === 'success' ? '#edf7ed' : '#e8f4fc';
        }
        
        // Создание canvas элемента
        function createCanvasElement(canvasId, title = '') {
            const container = document.getElementById('chartsContainer');
            
            // Проверяем, не существует ли уже
            if (document.getElementById(canvasId)) {
                return document.getElementById(canvasId);
            }
            
            const wrapper = document.createElement('div');
            wrapper.className = 'chart-wrapper';
            wrapper.innerHTML = `
                <h4>${title}</h4>
                <canvas id="${canvasId}"></canvas>
            `;
            
            container.appendChild(wrapper);
            
            // Добавляем прокрутку к новому графику
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            return document.getElementById(canvasId);
        }
        
        // Очистка всех графиков
        function clearCharts() {
            document.getElementById('chartsContainer').innerHTML = '';
            if (window.chartManager) {
                chartManager.destroyAll();
            }
            updateStatus('Все графики очищены', 'success');
        }
        
        async function testCategoryChart() {
            try {
                updateStatus('Загрузка данных...');
                
                const purchases = await apiClient.getPurchases();
                const categories = await apiClient.getCategories();
                
                updateStatus('Создание графика...');
                
                // Создаем canvas
                createCanvasElement('chart1', 'Расходы по категориям (Bar)');
                
                chartManager.createChartFromFactory('chart1', 'category-distribution', {
                    purchases,
                    categories
                }, {
                    type: 'bar',
                    title: 'Расходы по категориям'
                });
                
                updateStatus('График создан успешно!', 'success');
                
            } catch (error) {
                updateStatus(`Ошибка: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function testCategoryPie() {
            try {
                updateStatus('Загрузка данных...');
                
                const purchases = await apiClient.getPurchases();
                const categories = await apiClient.getCategories();
                
                updateStatus('Создание графика...');
                
                // Создаем canvas
                createCanvasElement('chart2', 'Распределение по категориям (Pie)');
                
                chartManager.createChartFromFactory('chart2', 'category-distribution', {
                    purchases,
                    categories
                }, {
                    type: 'pie',
                    title: 'Распределение расходов по категориям'
                });
                
                updateStatus('График создан успешно!', 'success');
                
            } catch (error) {
                updateStatus(`Ошибка: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function testMonthlyChart() {
            try {
                updateStatus('Загрузка данных...');
                
                const purchases = await apiClient.getPurchases();
                
                updateStatus('Создание графика...');
                
                // Создаем canvas
                createCanvasElement('chart3', 'Месячные расходы');
                
                chartManager.createChartFromFactory('chart3', 'monthly-expenses', {
                    purchases
                }, {
                    title: 'Расходы по месяцам'
                });
                
                updateStatus('График создан успешно!', 'success');
                
            } catch (error) {
                updateStatus(`Ошибка: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function testStoreChart() {
            try {
                updateStatus('Загрузка данных...');
                
                const purchases = await apiClient.getPurchases();
                const stores = await apiClient.getStores();
                
                updateStatus('Создание графика...');
                
                // Создаем canvas
                createCanvasElement('chart4', 'Сравнение магазинов');
                
                chartManager.createChartFromFactory('chart4', 'store-comparison', {
                    purchases,
                    stores
                }, {
                    horizontal: true,
                    title: 'Топ магазинов по расходам'
                });
                
                updateStatus('График создан успешно!', 'success');
                
            } catch (error) {
                updateStatus(`Ошибка: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function testTrendChart() {
            try {
                updateStatus('Загрузка данных...');
                
                const purchases = await apiClient.getPurchases();
                
                updateStatus('Создание графика...');
                
                // Создаем canvas
                createCanvasElement('chart5', 'Динамика расходов');
                
                chartManager.createChartFromFactory('chart5', 'expense-trend', {
                    purchases
                }, {
                    period: 'monthly',
                    title: 'Динамика расходов по месяцам'
                });
                
                updateStatus('График создан успешно!', 'success');
                
            } catch (error) {
                updateStatus(`Ошибка: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        function testToggleLabels() {
            const charts = ['chart1', 'chart2', 'chart3', 'chart4', 'chart5'];
            let toggled = 0;
            
            charts.forEach(chartId => {
                const chart = chartManager.getChart(chartId);
                if (chart) {
                    const enabled = !chart.dataLabelsEnabled;
                    chartManager.toggleDataLabels(chartId, enabled);
                    toggled++;
                }
            });
            
            updateStatus(`Переключены подписи у ${toggled} графиков`, 'success');
        }
        
        function testExportAll() {
            const charts = ['chart1', 'chart2', 'chart3', 'chart4', 'chart5'];
            let exported = 0;
            
            charts.forEach((chartId, index) => {
                const chart = chartManager.getChart(chartId);
                if (chart) {
                    setTimeout(() => {
                        chartManager.exportChart(chartId, `chart-${index + 1}.png`);
                        exported++;
                    }, index * 300);
                }
            });
            
            updateStatus(`Экспортировано ${exported} графиков`, 'success');
        }
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus('Готов к тестированию!');
            console.log('Тестовая страница загружена');
        });
		
		async function testInteractiveChart() {
			const purchases = await apiClient.getPurchases();
			const categories = await apiClient.getCategories();
			
			chartManager.createInteractiveChart('interactive-1', 'bar', 
				chartManager.dataProcessor.processCategoryData(purchases, categories),
				{
					plugins: {
						title: { display: true, text: 'Интерактивный график (кликайте!)' }
					}
				},
				{
					onClick: (data) => {
						console.log('Клик по:', data.label, data.value);
						alert(`Выбрано: ${data.label} - ${ChartUtils.formatCurrency(data.value)}`);
					}
				}
			);
		}

		async function testPeriodComparison() {
			const purchases = await apiClient.getPurchases();
			
			chartManager.createPeriodComparison('comparison-1', purchases, {
				title: 'Сравнение текущего и прошлого месяца'
			});
		}

		function testSaveConfig() {
			const saved = chartManager.saveChartConfig('interactive-1');
			alert(saved ? 'Конфигурация сохранена!' : 'Ошибка сохранения');
		}

		function testRestoreConfigs() {
			chartManager.restoreAllCharts();
			alert('Конфигурации восстановлены');
		}

		async function testComparisonDashboard() {
			const purchases = await apiClient.getPurchases();
			chartManager.createComparisonDashboard('comparisonDashboard', purchases);
		}
    </script>
</body>
</html>